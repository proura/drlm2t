#!/bin/bash

# Test to install DRLM from GitHub develeop branch 
# Expected output: 

apt-get update 
apt-get upgrade -y
apt-get install -y openssh-client openssl gawk nfs-kernel-server rpcbind isc-dhcp-server tftpd-hpa qemu-utils sqlite3 lsb-release bash-completion git build-essential debhelper golang
git clone https://github.com/brainupdaters/drlm
cd drlm
git checkout develop

export GOCACHE="/root/.cache/go-build"
export GOENV="/root/.config/go/env"
export GOMODCACHE="/root/go/pkg/mod"
export GOPATH="/root/go"

make deb
cd ..
dpkg -i drlm_2.4.0_all.deb

echo "nbd" > /etc/modules-load.d/nbd.conf
echo "options nbd max_part=8 nbds_max=1024" > /etc/modprobe.d/nbd.conf
modprobe nbd

sed -i '/TFTP_DIRECTORY="\/srv\/tftp"/c\TFTP_DIRECTORY="\/var\/lib\/drlm\/store"' /etc/default/tftpd-hpa

DHCP_NET="$(ip -o link show | awk -F': ' '{print $2}' | awk '!/lo/')"
sed -i "/INTERFACESv4=\"\"/c\INTERFACESv4=\"$(echo $DHCP_NET)\"" /etc/default/isc-dhcp-server

systemctl restart tftpd-hpa.service
systemctl restart rpcbind.service